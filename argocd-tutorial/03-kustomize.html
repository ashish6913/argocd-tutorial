<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kustomize :: ArgoCD Tutorial</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/03-kustomize.html">
    <link rel="prev" href="02-getting_started.html">
    <link rel="next" href="04-syncwaves-hooks.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-scholars.github.io/argocd-tutorial">ArgoCD Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="argocd-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#kubernetes">Setup Kubernetes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#install_argocd">Install ArgoCD</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-getting_started.html">Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-getting_started.html#connect_argocd">Connecting to ArgoCD</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-getting_started.html#deploy_sample_application">Deploy a Sample Application</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-kustomize.html">Work with Kustomize</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#exploring_kustomize">Exploring the Kustomize</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#exploring_kustomize_cli">Exploring the Kustomize CLI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#exploring_kustomize_with_kubectl">Exploring Kustomize with Kubectl</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#deploying_kustomized_application">Deploying Kustomized Application</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#argocd_web_console">The ArgoCD Web Console</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#kustomized_application">Kustomized Application</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-syncwaves-hooks.html">Sync Waves and Hooks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-syncwaves-hooks.html#using_syncwaves">Using Sync Waves</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-syncwaves-hooks.html#exploring_the_manifests">Exploring the Manifests</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-syncwaves-hooks.html#deploying_the_application">Deploying the Application</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-syncwaves-hooks.html#exploring_resource_hooks">Exploring Resource Hooks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-syncwaves-hooks.html#exploring_the_manifests_hooks">Exploring the Manifests</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-syncwaves-hooks.html#deploying_the_application_hooks">Deploying the Application</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">ArgoCD Tutorial</a></li>
    <li><a href="03-kustomize.html">Work with Kustomize</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/argocd-tutorial/edit/master/documentation/modules/ROOT/pages/03-kustomize.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Kustomize</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://kustomize.io/">Kustomize</a> traverses a Kubernetes manifest to add, remove or update configuration options without forking. It is available both as a standalone binary and as a native feature of <code>kubectl</code> (and by extension <code>oc</code>).</p>
</div>
<div class="paragraph">
<p>The principals of <code>kustomize</code> are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Purely declarative approach to configuration customization</p>
</li>
<li>
<p>Manage an arbitrary number of distinctly customized Kubernetes configurations</p>
</li>
<li>
<p>Every artifact that kustomize uses is plain YAML and can be validated and processed as such</p>
</li>
<li>
<p>As a "templateless" templating system; it encourages using YAML without forking the repo it.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/kustomize_logo.png" alt="Kustomize Logo">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="exploring_kustomize"><a class="anchor" href="#exploring_kustomize"></a>Exploring Kustomize</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="exploring_kustomize_cli"><a class="anchor" href="#exploring_kustomize_cli"></a>Exploring the Kustomize CLI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>kustomize</code> CLI should have been installed as part of the lab
setup. Verify that it has been installed.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kustomize version --short</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should display the version, it should look something like this.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">{kustomize/v4.0.5  2021-02-13T21:21:14Z  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Kustomize, at it&#8217;s core, is meant to build native Kubernetes manifests
based on YAML, while leaving the original YAML in tact. It achieves this
in a "template-less" templating format. This is done by providing a <code>kustomization.yaml</code> file.</p>
</div>
<div class="paragraph">
<p>We will be focusing on two sub-commands the <code>build</code> command and the
<code>edit</code> command.</p>
</div>
<div class="paragraph">
<p>The <code>build</code> command takes the YAML source (via a path or URL) and creates
a new YAML that can be piped into <code>kubectl create</code>. We will work with
an example in the <code>documentation/modules/ROOT/examples/kustomize-build</code> directory.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd documentation/modules/ROOT/examples/kustomize-build</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here you should see two files, a <code>kustomization.yaml</code> file and a <code>welcome.yaml</code> file, let&#8217;s have a look at them.</p>
</div>
<div class="listingblock">
<div class="title"><a href="" target="_blank" rel="noopener">welcome.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: welcome-php
  name: welcome-php
spec:
  replicas: 1
  selector:
    matchLabels:
      app: welcome-php
  strategy: {}
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: welcome-php
    spec:
      containers:
      - image: quay.io/redhatworkshops/welcome-php:latest
        name: welcome-php
        resources: {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This file shows nothing special. Just a standard Kubernetes manifest.</p>
</div>
<div class="paragraph">
<p>What if, for example, we wanted to add a <code>label</code> to this manifest without editing it? This is where the <code>kustomization.yaml</code> file comes in.</p>
</div>
<div class="listingblock">
<div class="title"><a href="" target="_blank" rel="noopener">kustomization.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- ./welcome.yaml
patchesJson6902:
- patch: |-
    - op: add
      path: /metadata/labels/testkey
      value: testvalue
  target:
    group: apps
    kind: Deployment
    name: welcome-php
    version: v1
images:
- name: quay.io/redhatworkshops/welcome-php
  newTag: ffcd15</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see in the output there isn&#8217;t much. The two sections for this
example are the <code>resources</code> and the <code>patchesJson6902</code> sections.</p>
</div>
<div class="paragraph">
<p><code>resources</code> is an array of individual files, directories, and/or URLs where other manifests are stored. In this example we are just loading in one file. The (<a href="https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/patchesjson6902/"><code>patchesJson6902</code> is a patching RFC</a> that <code>kustomize</code> supports. As you can see, in the <code>patchesJson6902</code> file, I am adding a label to this manifest.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>NOTE</strong> You can read about what options are available for patching in the <a href="https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/">official documentation site</a></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Build this manifest by running:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kustomize build</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that the new label got added to the manifest!</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: welcome-php
    testkey: testvalue
  name: welcome-php
spec:
  replicas: 1
  selector:
    matchLabels:
      app: welcome-php
  strategy: {}
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: welcome-php
    spec:
      containers:
      - image: quay.io/redhatworkshops/welcome-php:ffcd15
        name: welcome-php
        resources: {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the <code>kustomize edit</code> command instead of writing YAML. For
example, you can change the image tag this <code>Deployment</code> uses from <code>latest</code>
to <code>ffcd15</code> by running the following:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kustomize edit set image quay.io/redhatworkshops/welcome-php:ffcd15</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will update the <code>kustomization.yaml</code> file with a <code>images</code> section.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat kustomization.yaml</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- ./welcome.yaml
patchesJson6902:
- patch: |-
    - op: add
      path: /metadata/labels/testkey
      value: testvalue
  target:
    group: apps
    kind: Deployment
    name: welcome-php
    version: v1
images:
- name: quay.io/redhatworkshops/welcome-php
  newTag: ffcd15</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now when you run:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"> kustomize build .</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see not only the new label but also the new <code>ffcd15</code> image tag.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>NOTE</strong> You may have to close the <code>kustomization.yaml</code> tab and re-open it to see the changes.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>You can see how you can take already existing YAML and modify it for
your specific environment without the need to copy or edit the original.</p>
</div>
<div class="paragraph">
<p>Kustomize can be used to write a new YAML file or be pipped into
the <code>kubectl</code> (or <code>oc</code>) command. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kustomize build . | kubectl apply -f -</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="exploring_kustomize_with_kubectl"><a class="anchor" href="#exploring_kustomize_with_kubectl"></a>Exploring Kustomize with Kubectl</h3>
<div class="paragraph">
<p>Since Kubernetes 1.14, The <code>kubectl</code> command (and by extension the
<code>oc</code> cli) has support for Kustomize built in.</p>
</div>
<div class="paragraph">
<p>You can see this by running:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl kustomize --help</code></pre>
</div>
</div>
<div class="paragraph">
<p>This runs the <code>kustomize build</code> command. You can see this by running:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl kustomize</code></pre>
</div>
</div>
<div class="paragraph">
<p>Although you can use this to pipe it into the apply command, you
don&#8217;t have to. The <code>kubectl apply</code> command has the <code>-k</code> option that
will run the build before it applies the manifest.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset1_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_minikube">
<div class="paragraph">
<p>To test this out, first create a namespace:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl create namespace kustomize-test</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next make sure you&#8217;re on the namespace:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl config set-context --current --namespace=kustomize-test</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_openshift">
<div class="paragraph">
<p>To test this out, first create a project:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc new-project kustomize-test</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next make sure you&#8217;re on the project:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc project kustomize-test</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Finally run the command to build and apply the manifests:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -k ./</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>NOTE</strong> You can pass not only directories, but URLs as well. The
only requirement is that you have a <code>kustomization.yaml</code> file in
the path.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This should create the deployment and you should see the pods running in the namespace:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get pods -n kustomize-test</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see the deployment was created with the additional labels:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get deployment welcome-php -o jsonpath='{.metadata.labels}' | jq -r</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, the image was updated based on the customization that was made:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get deploy welcome-php  -o jsonpath='{.spec.template.spec.containers[].image}{"\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see <code>kustomize</code> can be a powerful tool.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset2_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_minikube">
<div class="paragraph">
<p>You can now safely delete this namespace:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete namespace kustomize-test</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_openshift">
<div class="paragraph">
<p>If you want, you can now delete this project as we won&#8217;t use it for next steps</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete project kustomize-test</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying_kustomized_application"><a class="anchor" href="#deploying_kustomized_application"></a>Deploying Kustomized Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In previous chapter, you learned that in a GitOps workflow; the
entire application stack (including infrastructure) is reflected
in a git repo. The challenge is how to do this without duplicating
YAML.</p>
</div>
<div class="paragraph">
<p>So now that you&#8217;ve explored <code>kustomize</code>, let&#8217;s see how it fits into Argo
CD and how it can be used in a GitOps workflow.</p>
</div>
<div class="paragraph">
<p>Before preceeding, move back into the home directory:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd -</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="argocd_web_console"><a class="anchor" href="#argocd_web_console"></a>The Argo CD Web Console</h3>
<div class="paragraph">
<p>Access Argo CD Web Console.</p>
</div>
<div class="paragraph">
<p>Once you have accepted the self signed certificate, you should be
presented with the Argo CD login screen.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd-login.png" alt="ArgoCD Login">
</div>
</div>
<div class="paragraph">
<p>You can login with the following</p>
</div>
<div class="paragraph">
<p><strong>Username</strong>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">admin</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Password</strong>:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset3_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_minikube">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_openshift">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc extract secret/openshift-gitops-cluster -n openshift-gitops --to=-</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kustomized_application"><a class="anchor" href="#kustomized_application"></a>Kustomized Application</h3>
<div class="paragraph">
<p>Argo CD has native support for Kustomize. You can use this to avoid
duplicating YAML for each deployment. This is especially good to
use if you have different environments or clusters you&#8217;re deploying
to.</p>
</div>
<div class="paragraph">
<p>Take a look at the <code>Application</code> definition:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset4_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset4_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset4_minikube">
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-developer-demos/openshift-gitops-examples/tree/minikube/apps/bgd/overlays/bgdk" target="_blank" rel="noopener">bgdk-app.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: bgdk-app
  namespace: argocd
spec:
  destination:
    namespace: bgdk
    server: <a href="https://kubernetes.default.svc" class="bare">https://kubernetes.default.svc</a>
  project: default
  source:
    path: apps/bgd/overlays/bgdk
    repoURL: <a href="https://github.com/redhat-developer-demos/openshift-gitops-examples" class="bare">https://github.com/redhat-developer-demos/openshift-gitops-examples</a>
    targetRevision: minikube
  syncPolicy:
    automated:
      prune: true
      selfHeal: false
    syncOptions:
    - CreateNamespace=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>This application is pointed to the <a href="https://github.com/redhat-developer-demos/openshift-gitops-examples">same repo</a> but <a href="https://github.com/redhat-developer-demos/openshift-gitops-examples/tree/minikube/apps/bgd/overlays/bgdk">different directory</a>.</p>
</div>
<div class="paragraph">
<p>This is using a concept of an "overlay", where you have a "base"
set of manifests and you overlay your customizations.</p>
</div>
<div class="paragraph">
<p>Take a look at the <code>kustomization.yaml</code> file:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-developer-demos/openshift-gitops-examples/tree/minikube/apps/bgd/overlays/bgdk/kustomization.yaml" target="_blank" rel="noopener">kustomization.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: bgdk
resources:
- ../../base
- bgdk-ns.yaml
patchesJson6902:
  - target:
      version: v1
      group: apps
      kind: Deployment
      name: bgd
      namespace: bgdk
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/env/0/value
        value: yellow
  - target:
      version: v1
      group: networking.k8s.io
      kind: Ingress
      name: bgd
      namespace: bgdk
    patch: |-
      - op: replace
        path: /spec/rules/0/host
        value: bgdk.devnation</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>kustomization.yaml</code> take the base application and patches the
manifest so that we get a yellow square instead of a blue one. It
also deploys the application to the <code>bgdk</code> namespace (denoted by
the <code>namespace:</code> section of the file) and update the Ingress hostname for this new namespace to be <code>bgdk.devnation</code>.</p>
</div>
<div class="paragraph">
<p>Add Minikube IP (<code>minikube ip</code>) and the Ingress hostname <code>bgdk.devnation</code> to your Host file, like <code>/etc/hosts</code>.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">192.168.39.242 bgd.devnation bgdk.devnation</code></pre>
</div>
</div>
<div class="paragraph">
<p>Deploy this application:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f documentation/modules/ROOT/examples/minikube/bgdk-app/bgdk-app.yaml</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset4_openshift">
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-developer-demos/openshift-gitops-examples/tree/main/apps/bgd/overlays/bgdk" target="_blank" rel="noopener">bgdk-app.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: bgdk-app
  namespace: openshift-gitops
spec:
  destination:
    namespace: bgdk
    server: <a href="https://kubernetes.default.svc" class="bare">https://kubernetes.default.svc</a>
  project: default
  source:
    path: apps/bgd/overlays/bgdk
    repoURL: <a href="https://github.com/redhat-developer-demos/openshift-gitops-examples" class="bare">https://github.com/redhat-developer-demos/openshift-gitops-examples</a>
    targetRevision: main
  syncPolicy:
    automated:
      prune: true
      selfHeal: false
    syncOptions:
    - CreateNamespace=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>This application is pointed to the <a href="https://github.com/redhat-developer-demos/openshift-gitops-examples">same repo</a> but <a href="https://github.com/redhat-developer-demos/openshift-gitops-examples/tree/main/apps/bgd/overlays/bgdk">different directory</a>.</p>
</div>
<div class="paragraph">
<p>This is using a concept of an "overlay", where you have a "base"
set of manifests and you overlay your customizations.</p>
</div>
<div class="paragraph">
<p>Take a look at the <code>kustomization.yaml</code> file:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-developer-demos/openshift-gitops-examples/tree/main/apps/bgd/overlays/bgdk/kustomization.yaml" target="_blank" rel="noopener">kustomization.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: bgdk
resources:
- ../../base
- bgdk-ns.yaml
patchesJson6902:
  - target:
      version: v1
      group: apps
      kind: Deployment
      name: bgd
      namespace: bgdk
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/env/0/value
        value: yellow</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>kustomization.yaml</code> take the base application and patches the
manifest so that we get a yellow square instead of a blue one. It
also deploys the application to the <code>bgdk</code> namespace (denoted by
the <code>namespace:</code> section of the file).</p>
</div>
<div class="paragraph">
<p>Deploy this application:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f documentation/modules/ROOT/examples/bgdk-app/bgdk-app.yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This should show you two apps on the Argo CD UI.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/two-apps.png" alt="Two Apps">
</div>
</div>
<div class="paragraph">
<p>Open the application&#8217;s Ingress or Route.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/yellow-square.png" alt="Yellow Square">
</div>
</div>
<div class="paragraph">
<p>As you can see, the application deployed with your customizations! To review what we just did.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deployed an Application called <code>bgd</code> with a blue square.</p>
</li>
<li>
<p>Deployed another Application based on <code>bgd</code> called <code>bgdk</code></p>
</li>
<li>
<p>The Application <code>bgdk</code> was deployed in it&#8217;s own namespace, with deployment customizations.</p>
</li>
<li>
<p>ALL without having to duplicate YAML!</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="02-getting_started.html">Getting Started</a></span>
  <span class="next"><a href="04-syncwaves-hooks.html">Sync Waves and Hooks</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
